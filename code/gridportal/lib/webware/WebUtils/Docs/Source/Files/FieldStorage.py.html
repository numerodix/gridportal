<HTML><HEAD><TITLE>WebUtils/FieldStorage.py</TITLE></HEAD>
                  <BODY BGCOLOR=#EEEEEE>
                  <!--header-->
                  <!--script--><PRE>

<FONT COLOR=#FF0000>"""
This module defines a subClass of the standard python cgi.FieldStorage class with an extra method that will allow a FieldStorage to parse a query string even in a POST request.
"""</FONT>


<FONT COLOR=black><B>import</B></FONT> cgi, os, urllib, string

<FONT COLOR=black><B>class</B></FONT> FieldStorage(cgi.FieldStorage):

    <FONT COLOR=black><B>def</B></FONT> __init__(self, fp=None, headers=None, outerboundary=<FONT COLOR=#FF0000>""</FONT>,
                 environ=os.environ, keep_blank_values=0, strict_parsing=0):
        self._environ = environ
        self._strict_parsing = strict_parsing
        self._keep_blank_values = keep_blank_values
        cgi.FieldStorage.__init__(self, fp, headers, outerboundary, environ, keep_blank_values, strict_parsing)
    
    <FONT COLOR=black><B>def</B></FONT> parse_qs(self):
        <FONT COLOR=#FF0000>"""
        Explicitly parse the query string, even if it's a POST request
        """</FONT>
        self._method = string.upper(self._environ[<FONT COLOR=#FF0000>'REQUEST_METHOD'</FONT>])
        <FONT COLOR=black><B>if</B></FONT> self._method == <FONT COLOR=#FF0000>"GET"</FONT> <FONT COLOR=black><B>or</B></FONT>  self._method == <FONT COLOR=#FF0000>"HEAD"</FONT>:
<FONT COLOR=#1111CC>##          print __file__, "bailing on GET or HEAD request"</FONT>
            <FONT COLOR=black><B>return</B></FONT>  <FONT COLOR=#1111CC>#bail because cgi.FieldStorage already did this</FONT>
        self._qs = self._environ.get(<FONT COLOR=#FF0000>'QUERY_STRING'</FONT>, None)
        <FONT COLOR=black><B>if</B></FONT> <FONT COLOR=black><B>not</B></FONT> self._qs:
<FONT COLOR=#1111CC>##          print __file__, "bailing on no query_string"</FONT>
            <FONT COLOR=black><B>return</B></FONT>  <FONT COLOR=#1111CC>##bail if no query string</FONT>


        name_value_pairs = string.splitfields(self._qs, <FONT COLOR=#FF0000>'&'</FONT>)
        dict = {}
        <FONT COLOR=black><B>for</B></FONT> name_value <FONT COLOR=black><B>in</B></FONT> name_value_pairs:
            nv = string.splitfields(name_value, <FONT COLOR=#FF0000>'='</FONT>)
            <FONT COLOR=black><B>if</B></FONT> len(nv) != 2:
                <FONT COLOR=black><B>if</B></FONT> self._strict_parsing:
                    <FONT COLOR=black><B>raise</B></FONT> ValueError, <FONT COLOR=#FF0000>"bad query field: %s"</FONT> % `name_value`
                <FONT COLOR=black><B>continue</B></FONT>
            name = urllib.unquote(string.replace(nv[0], <FONT COLOR=#FF0000>'+'</FONT>, <FONT COLOR=#FF0000>' '</FONT>))
            value = urllib.unquote(string.replace(nv[1], <FONT COLOR=#FF0000>'+'</FONT>, <FONT COLOR=#FF0000>' '</FONT>))
            <FONT COLOR=black><B>if</B></FONT> len(value) <FONT COLOR=black><B>or</B></FONT> self._keep_blank_values:
                <FONT COLOR=black><B>if</B></FONT> dict.has_key (name):
                    dict[name].append(value)
                    <FONT COLOR=#1111CC>##print "appending"</FONT>
                <FONT COLOR=black><B>else</B></FONT>:
                    dict[name] = [value]
                    <FONT COLOR=#1111CC>##print "no append"</FONT>

        <FONT COLOR=#1111CC># Only append values that aren't already in the FieldStorage's keys;</FONT>
        <FONT COLOR=#1111CC># This makes POSTed vars override vars on the query string</FONT>
        <FONT COLOR=black><B>if</B></FONT> <FONT COLOR=black><B>not</B></FONT> self.list:
            <FONT COLOR=#1111CC># This makes sure self.keys() are available, even</FONT>
            <FONT COLOR=#1111CC># when valid POST data wasn't encountered.</FONT>
            self.list = [] 
        keys = self.keys()
        <FONT COLOR=black><B>for</B></FONT> key, values <FONT COLOR=black><B>in</B></FONT> dict.items():
            <FONT COLOR=black><B>if</B></FONT> key <FONT COLOR=black><B>not</B></FONT> <FONT COLOR=black><B>in</B></FONT> keys:
                <FONT COLOR=black><B>for</B></FONT> value <FONT COLOR=black><B>in</B></FONT> values:
                    self.list.append(cgi.MiniFieldStorage(key,value))
<FONT COLOR=#1111CC>##                  print "adding %s=%s" % (str(key),str(value))</FONT>
            


        
</PRE>
                  <!--footer-->
                  </BODY>
