<HTML><HEAD><TITLE>WebUtils/WDGValidator.py</TITLE></HEAD>
                  <BODY BGCOLOR=#EEEEEE>
                  <!--header-->
                  <!--script--><PRE><FONT COLOR=black><B>from</B></FONT> WebUtils.Funcs <FONT COLOR=black><B>import</B></FONT> htmlEncode
<FONT COLOR=black><B>try</B></FONT>:
    <FONT COLOR=black><B>from</B></FONT> cStringIO <FONT COLOR=black><B>import</B></FONT> StringIO
<FONT COLOR=black><B>except</B></FONT> ImportError:
    <FONT COLOR=black><B>from</B></FONT> StringIO <FONT COLOR=black><B>import</B></FONT> StringIO
<FONT COLOR=black><B>import</B></FONT> os, string

<FONT COLOR=black><B>def</B></FONT> encodeWithIndentation(html):
    html = string.replace(htmlEncode(html), <FONT COLOR=#FF0000>'  '</FONT>, <FONT COLOR=#FF0000>'&nbsp; '</FONT>)
    <FONT COLOR=black><B>return</B></FONT> string.replace(html, <FONT COLOR=#FF0000>'\t'</FONT>, <FONT COLOR=#FF0000>'&nbsp;&nbsp;&nbsp;&nbsp;'</FONT>)

<FONT COLOR=black><B>def</B></FONT> validateHTML(html):
    <FONT COLOR=#FF0000>"""
    Validate the input using Web Design Group's HTML validator
    available at http://www.htmlhelp.com/tools/validator/

    Make sure you install the offline validator (called
    "validate") which can be called from the command-line.  The
    "validate" script must be in your path.

    If no errors are found, an empty string is returned.
    Otherwise, the HTML with the error messages is returned.
    """</FONT>

    input, output = os.popen4(<FONT COLOR=#FF0000>'validate'</FONT>)
    input.write(html)
    input.close()
    out = output.readlines() 
    output.close()
    
    errorLines = {}
    <FONT COLOR=black><B>for</B></FONT> line <FONT COLOR=black><B>in</B></FONT> out:
        <FONT COLOR=black><B>if</B></FONT> line[0:5] == <FONT COLOR=#FF0000>'Line '</FONT>:
            i = line.find(<FONT COLOR=#FF0000>','</FONT>)
            <FONT COLOR=black><B>if</B></FONT> i != -1:
                linenum = int(line[5:i])
                errorLines[linenum] = line

    <FONT COLOR=#1111CC># Be quiet if all's well</FONT>
    <FONT COLOR=black><B>if</B></FONT> <FONT COLOR=black><B>not</B></FONT> errorLines:
        <FONT COLOR=black><B>return</B></FONT> <FONT COLOR=#FF0000>''</FONT>

    result = StringIO()
    result.write(<FONT COLOR=#FF0000>'&lt;table style="background-color: #ffffff"&gt;&lt;tr&gt;&lt;td colspan="2"&gt;\n'</FONT>)
    result.write(<FONT COLOR=#FF0000>"&lt;pre&gt;%s&lt;/pre&gt;"</FONT> % <FONT COLOR=#FF0000>""</FONT>.join(out) )
    result.write(<FONT COLOR=#FF0000>'&lt;/td&gt;&lt;/tr&gt;\n'</FONT>)

    goodColors = [<FONT COLOR=#FF0000>'#d0d0d0'</FONT>, <FONT COLOR=#FF0000>'#e0e0e0'</FONT>]
    badColor = <FONT COLOR=#FF0000>'#ffd0d0'</FONT>
    lines = html.splitlines(1)
    i = 1
    <FONT COLOR=black><B>for</B></FONT> line <FONT COLOR=black><B>in</B></FONT> lines:
        <FONT COLOR=black><B>if</B></FONT> errorLines.has_key(i):
            result.write(<FONT COLOR=#FF0000>'&lt;tr style="background-color: %s"&gt;&lt;td rowspan="2"&gt;%d&lt;/td&gt;&lt;td&gt;%s&lt;/td&gt;&lt;/tr&gt;\n'</FONT> % (badColor, i, encodeWithIndentation(errorLines[i])))
            result.write(<FONT COLOR=#FF0000>'&lt;tr style="background-color: %s"&gt;&lt;td&gt;%s&lt;/td&gt;&lt;/tr&gt;\n'</FONT> % (badColor, encodeWithIndentation(line)))
        <FONT COLOR=black><B>else</B></FONT>:
            color = goodColors[i % 2]
            result.write(<FONT COLOR=#FF0000>'&lt;tr style="background-color: %s"&gt;&lt;td&gt;%d&lt;/td&gt;&lt;td&gt;%s&lt;/td&gt;&lt;/tr&gt;\n'</FONT> % (color, i, encodeWithIndentation(line)))
        i += 1
    result.write(<FONT COLOR=#FF0000>'&lt;/table&gt;\n'</FONT>)
    <FONT COLOR=black><B>return</B></FONT> result.getvalue()
</PRE>
                  <!--footer-->
                  </BODY>
