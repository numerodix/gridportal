<HTML><HEAD><TITLE>TaskKit/TaskHandler.py</TITLE></HEAD>
                  <BODY BGCOLOR=#EEEEEE>
                  <!--header-->
                  <!--script--><PRE><FONT COLOR=black><B>
from</B></FONT> time <FONT COLOR=black><B>import</B></FONT> time, sleep
<FONT COLOR=black><B>from</B></FONT> threading <FONT COLOR=black><B>import</B></FONT> Event, Thread


<FONT COLOR=black><B>class</B></FONT> TaskHandler:
    <FONT COLOR=#FF0000>"""
    While the Task class only knows what task to perform with the run()-method, 
    the TaskHandler has all the knowledge about the periodicity of the task.
    Instances of this class are managed by the Scheduler in the
    scheduled, running and onDemand dictionaries.
    """</FONT>

    <FONT COLOR=#1111CC>## Init ##</FONT>

    <FONT COLOR=black><B>def</B></FONT> __init__(self, scheduler, start, period, task, name):
        self._scheduler = scheduler
        self._task = task
        self._name = name
        self._thread = None
        self._isRunning = 0
        self._suspend = 0
        self._lastTime = None
        self._startTime = start
        self._registerTime = time()
        self._reregister = 1
        self._rerun = 0
        self._period = abs(period)

    
    <FONT COLOR=#1111CC>## Scheduling ##</FONT>
    
    <FONT COLOR=black><B>def</B></FONT> reset(self, start, period, task, reregister):
        self._startTime = start
        self._period = abs(period)
        self._task = task
        self._reregister = reregister

    <FONT COLOR=black><B>def</B></FONT> runTask(self):
        <FONT COLOR=#FF0000>"""
        Runs this task in a background thread.
        """</FONT>
        <FONT COLOR=black><B>if</B></FONT> self._suspend:
            self._scheduler.notifyCompletion(self)
            <FONT COLOR=black><B>return</B></FONT>
        self._rerun = 0
        self._thread = Thread(None, self._task._run, self.name(), (self,))
        self._isRunning = 1
        self._thread.start()

    <FONT COLOR=black><B>def</B></FONT> reschedule(self):
        <FONT COLOR=#FF0000>"""
        Method to determine whether this task should be rescheduled. Increments the 
        startTime and returns true if this is a periodically executed task.
        """</FONT>
        <FONT COLOR=black><B>if</B></FONT> self._period == 0:
            <FONT COLOR=black><B>return</B></FONT> 0
        <FONT COLOR=black><B>else</B></FONT>:
            <FONT COLOR=black><B>if</B></FONT> self._lastTime - self._startTime &gt; self._period:  <FONT COLOR=#1111CC>#if </FONT>the time taken to run the task exceeds the period
                self._startTime = self._lastTime + self._period
            <FONT COLOR=black><B>else</B></FONT>:
                self._startTime = self._startTime + self._period
            <FONT COLOR=black><B>return</B></FONT> 1

    <FONT COLOR=black><B>def</B></FONT> notifyCompletion(self):
        self._isRunning = 0
        self._lastTime = time()
        self._scheduler.notifyCompletion(self)
        
        
    <FONT COLOR=#1111CC>## Attributes ##</FONT>
    
    <FONT COLOR=black><B>def</B></FONT> isRunning(self):
        <FONT COLOR=black><B>return</B></FONT> self._isRunning
    
    <FONT COLOR=black><B>def</B></FONT> runAgain(self):
        <FONT COLOR=#FF0000>"""
        This method lets the Scheduler check to see whether this task should be 
        re-run when it terminates
        """</FONT>
        <FONT COLOR=black><B>return</B></FONT> self._rerun

    <FONT COLOR=black><B>def</B></FONT> isOnDemand(self):
        <FONT COLOR=#FF0000>"""
        Returns true if this task is not scheduled for periodic execution.
        """</FONT>
        <FONT COLOR=black><B>return</B></FONT> self._period == 1

    <FONT COLOR=black><B>def</B></FONT> runOnCompletion(self):
        <FONT COLOR=#FF0000>"""
        Method to request that this task be re-run after its current completion. 
        Intended for on-demand tasks that are requested by the Scheduler while 
        they are already running.
        """</FONT>
        self._rerun = 1

    <FONT COLOR=black><B>def</B></FONT> unregister(self):
        <FONT COLOR=#FF0000>"""
        Method to request that this task not be kept after its current completion. 
        Used to remove a task from the scheduler
        """</FONT>
        self._reregister = 0
        self._rerun = 0

    <FONT COLOR=black><B>def</B></FONT> disable(self):
        <FONT COLOR=#FF0000>"""
        Method to disable future invocations of this task.
        """</FONT>
        self._suspend = 1

    <FONT COLOR=black><B>def</B></FONT> enable(self):
        <FONT COLOR=#FF0000>"""
        Method to enable future invocations of this task.
        """</FONT>
        self._suspend = 0

    <FONT COLOR=black><B>def</B></FONT> period(self):
        <FONT COLOR=#FF0000>"""
        Returns the period of this task.
        """</FONT>
        <FONT COLOR=black><B>return</B></FONT> self._period

    <FONT COLOR=black><B>def</B></FONT> setPeriod(self, period):
        <FONT COLOR=#FF0000>"""
        Mmethod to change the period for this task.
        """</FONT>
        self._period = period

    <FONT COLOR=black><B>def</B></FONT> stop(self):
        self._isRunning = 0

    <FONT COLOR=black><B>def</B></FONT> name(self):
        <FONT COLOR=black><B>return</B></FONT> self._name

    <FONT COLOR=black><B>def</B></FONT> startTime(self, newTime=None):
        <FONT COLOR=black><B>if</B></FONT> newTime:
            self._startTime = newTime
        <FONT COLOR=black><B>return</B></FONT> self._startTime
</PRE>
                  <!--footer-->
                  </BODY>
