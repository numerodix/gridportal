<HTML><HEAD><TITLE>MiscUtils/MixIn.py</TITLE></HEAD>
                  <BODY BGCOLOR=#EEEEEE>
                  <!--header-->
                  <!--script--><PRE><FONT COLOR=black><B>from</B></FONT> types <FONT COLOR=black><B>import</B></FONT> MethodType
<FONT COLOR=black><B>import</B></FONT> sys

<FONT COLOR=black><B>if</B></FONT> hasattr(sys, <FONT COLOR=#FF0000>'version_info'</FONT>) <FONT COLOR=black><B>and</B></FONT> sys.version_info[0]&gt;=2:
    <FONT COLOR=black><B>def</B></FONT> MixIn(pyClass, mixInClass, makeAncestor=0):
        <FONT COLOR=#FF0000>"""
        Mixes in the attributes of the mixInClass into the pyClass. These attributes are typically methods (but don't have to be). Note that private attributes, denoted by a double underscore, are not mixed in. Collisions are resolved by the mixInClass' attribute overwriting the pyClass'. This gives mix-ins the power to override the behavior of the pyClass.

        After using MixIn(), instances of the pyClass will respond to the messages of the mixInClass.

        An assertion fails if you try to mix in a class with itself.

        The pyClass will be given a new attribute mixInsForCLASSNAME which is a list of all mixInClass' that have ever been installed, in the order they were installed. You may find this useful for inspection and debugging.

        You are advised to install your mix-ins at the start up of your program, prior to the creation of any objects. This approach will result in less headaches. But like most things in Python, you're free to do whatever you're willing to live with.  :-)

        There is a bitchin' article in the Linux Journal, April 2001, "Using Mix-ins with Python" by Chuck Esterbrook which gives a thorough treatment of this topic.

        An example, that resides in Webware, is MiddleKit.Core.ModelUser.py, which install mix-ins for SQL adapters. Search for "MixIn(".

        If makeAncestor is 1, then a different technique is employed: the mixInClass is made the first base class of the pyClass. You probably don't need to use this and if you do, be aware that your mix-in can no longer override attributes/methods in pyClass.

        This function only exists if you are using Python 2.0 or later. Python 1.5.2 has a problem where functions (as in aMethod.im_func) are tied to their class, when in fact, they should be totally generic with only the methods being tied to their class. Apparently this was fixed in Py 2.0.
        """</FONT>
        <FONT COLOR=black><B>assert</B></FONT> mixInClass <FONT COLOR=black><B>is</B></FONT> <FONT COLOR=black><B>not</B></FONT> pyClass, <FONT COLOR=#FF0000>'mixInClass = %r, pyClass = %r'</FONT> % (mixInClass, pyClass)
        <FONT COLOR=black><B>if</B></FONT> makeAncestor:
            <FONT COLOR=black><B>if</B></FONT> mixInClass <FONT COLOR=black><B>not</B></FONT> <FONT COLOR=black><B>in</B></FONT> pyClass.__bases__:
                pyClass.__bases__ = (mixInClass,) + pyClass.__bases__
        <FONT COLOR=black><B>else</B></FONT>:
            <FONT COLOR=#1111CC># Recursively traverse the mix-in ancestor classes in order</FONT>
            <FONT COLOR=#1111CC># to support inheritance</FONT>
            baseClasses = list(mixInClass.__bases__)
            baseClasses.reverse()
            <FONT COLOR=black><B>for</B></FONT> baseClass <FONT COLOR=black><B>in</B></FONT> baseClasses:
                MixIn(pyClass, baseClass)

            <FONT COLOR=#1111CC># Track the mix-ins made for a particular class</FONT>
            attrName = <FONT COLOR=#FF0000>'mixInsFor'</FONT>+pyClass.__name__
            mixIns = getattr(pyClass, attrName, None)
            <FONT COLOR=black><B>if</B></FONT> mixIns <FONT COLOR=black><B>is</B></FONT> None:
                mixIns = []
                setattr(pyClass, attrName, mixIns)

            <FONT COLOR=#1111CC># Make sure we haven't done this before</FONT>
            <FONT COLOR=#1111CC># Er, woops. Turns out we like to mix-in more than once sometimes.</FONT>
            <FONT COLOR=#1111CC>#assert </FONT>not mixInClass <FONT COLOR=black><B>in</B></FONT> mixIns, <FONT COLOR=#FF0000>'pyClass = %r, mixInClass = %r, mixIns = %r'</FONT> % (pyClass, mixInClass, mixIns)

            <FONT COLOR=#1111CC># Record our deed for future inspection</FONT>
            mixIns.append(mixInClass)

            <FONT COLOR=#1111CC># Install the mix-in methods into the class</FONT>
            <FONT COLOR=black><B>for</B></FONT> name <FONT COLOR=black><B>in</B></FONT> dir(mixInClass):
                <FONT COLOR=black><B>if</B></FONT> <FONT COLOR=black><B>not</B></FONT> name.startswith(<FONT COLOR=#FF0000>'__'</FONT>): <FONT COLOR=#1111CC># skip private members</FONT>
                    member = getattr(mixInClass, name)
                    <FONT COLOR=black><B>if</B></FONT> type(member) <FONT COLOR=black><B>is</B></FONT> MethodType:
                        member = member.im_func
                    setattr(pyClass, name, member)
</PRE>
                  <!--footer-->
                  </BODY>
